<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dialogue Editor</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    textarea { width: 100%; height: 150px; }
    .tag { display: inline-block; background: #ddd; padding: 4px 8px; margin: 2px; border-radius: 6px; }
    button { margin: 5px; padding: 6px 12px; }
    .preview { border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: auto; }
    #suggestions { margin-top: 5px; }
    .suggestion { display: inline-block; background: #eee; padding: 4px 8px; margin: 2px; border: 1px solid #aaa; cursor: pointer; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Dialogue Editor</h1>

  <!-- Personajes -->
  <h2>Personajes</h2>
  <input id="charInput" placeholder="Nuevo personaje">
  <button onclick="addCharacter()">Agregar</button>
  <div id="charList"></div>

  <!-- Texto -->
  <h2>Escribir diálogo</h2>
  <textarea id="dialogueInput" placeholder="Ejemplo: Z: Hola mundo"></textarea>
  <div id="suggestions"></div>

  <!-- Vista previa -->
  <h2>Vista previa</h2>
  <div id="preview" class="preview"></div>

  <!-- Nombre del archivo -->
  <h2>Nombre del archivo</h2>
  <input id="fileName" placeholder="dialogues.json" value="dialogues.json">

  <!-- Botón exportar -->
  <br>
  <button onclick="exportJSON()">Exportar JSON</button>

  <script>
    let characters = [];
    let dialogues = [];

    function addCharacter() {
      const input = document.getElementById("charInput");
      const name = input.value.trim();
      if (name && !characters.includes(name)) {
        characters.push(name);
        renderCharacters();
      }
      input.value = "";
    }

    function renderCharacters() {
      const list = document.getElementById("charList");
      list.innerHTML = "";
      characters.forEach(c => {
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = c;
        list.appendChild(span);
      });
    }

    const dialogueInput = document.getElementById("dialogueInput");
    const suggestionsDiv = document.getElementById("suggestions");

    dialogueInput.addEventListener("input", (e) => {
      const lines = e.target.value.split("\n").map(line => {
        const [char, ...rest] = line.split(":");
        return {
          character: char?.trim(),
          text: rest.join(":").replace(/""/g, "''").trim()
        };
      }).filter(d => d.character && d.text);

      dialogues = lines;
      renderPreview();

      showSuggestions();
    });

    dialogueInput.addEventListener("keydown", (e) => {
      if (e.key === "Tab") {
        e.preventDefault();
        autocomplete();
      }
    });

    function showSuggestions() {
      suggestionsDiv.innerHTML = "";
      const text = dialogueInput.value.split("\n").pop(); // última línea
      const currentWord = text.split(":")[0].trim().toLowerCase();

      if (!currentWord) return;

      const matches = characters.filter(c => c.toLowerCase().startsWith(currentWord));
      matches.forEach(m => {
        const btn = document.createElement("span");
        btn.className = "suggestion";
        btn.textContent = m;
        btn.onclick = () => insertAutocomplete(m);
        suggestionsDiv.appendChild(btn);
      });
    }

    function autocomplete() {
      const text = dialogueInput.value.split("\n");
      const lastLine = text[text.length - 1];
      const currentWord = lastLine.split(":")[0].trim().toLowerCase();
      const match = characters.find(c => c.toLowerCase().startsWith(currentWord));
      if (match) {
        text[text.length - 1] = match + ": ";
        dialogueInput.value = text.join("\n");
        dialogueInput.setSelectionRange(dialogueInput.value.length, dialogueInput.value.length);
        suggestionsDiv.innerHTML = "";
      }
    }

    function insertAutocomplete(name) {
      const text = dialogueInput.value.split("\n");
      text[text.length - 1] = name + ": ";
      dialogueInput.value = text.join("\n");
      dialogueInput.focus();
      suggestionsDiv.innerHTML = "";
    }

    function renderPreview() {
      const preview = document.getElementById("preview");
      preview.innerHTML = "";
      dialogues.forEach(d => {
        const p = document.createElement("p");
        p.innerHTML = `<b>${d.character}:</b> ${d.text}`;
        preview.appendChild(p);
      });
    }

    function exportJSON() {
      const data = { dialogue: dialogues };
      let filename = document.getElementById("fileName").value.trim();
      if (!filename.endsWith(".json")) filename += ".json";

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>